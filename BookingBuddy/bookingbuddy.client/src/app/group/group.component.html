<div *ngIf="!global_loading" class="row justify-content-center mt-4 w-100">
  <!-- Coluna esquerda com os grupos e os membros -->
  <div class="col-md-3 mb-5">
    <div class="accordion mb-3" id="accordionGroups">
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingOne1">
          <button class="accordion-button collapsed shadow-sm" type="button" data-bs-toggle="collapse"
                  data-bs-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
            Lista de Grupos
          </button>
        </h2>
        <div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne"
             data-bs-parent="#accordionGroups">
          <div class="overflow-auto accordion-body p-1 overflow-auto" style="max-height: 350px">
            <div class="list-group list-group-flush overflow-auto">
              <div class="mx-auto p-2">
                <span class="text-muted small">
                  Criar um grupo de reserva
                  <button type="button"
                          class="btn btn-outline-success btn-sm rounded-pill ms-2"
                          routerLink="/group-booking">
                    <i class="bi bi-person-fill-add"></i>
                  </button>
                </span>
              </div>
              <hr class="m-0"/>
              <span class="mx-auto p-2 fw-bold small"
                    *ngIf="group_list.length == 0">Não existem grupos de reserva</span>
              <button *ngFor="let group of group_list" class="list-group-item list-group-item-action"
                      (click)="chooseGroup(group.groupId)"
                      [ngClass]="{'bg-success text-white': group === currentGroup}">
                <div class="d-flex justify-content-between align-items-center">
                  <div class="fw-bold">{{ group.name }}</div>
                  <!--                  <span class="badge bg-success-medium rounded">{{ group.membersId.length }}<i-->
                  <!--                    class="bi bi-person ms-1"></i></span>-->
                </div>
                <!--<span class="text-muted small text-truncate">{{group.lastMessage.member}}: {{group.lastMessage.message}}</span>-->
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="accordion" id="accordionMembers" *ngIf="currentGroup">
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingOne">
          <button class="accordion-button collapsed shadow-sm" type="button" data-bs-toggle="collapse"
                  data-bs-target="#collapseOneMembers" aria-expanded="false" aria-controls="collapseOneMembers">
            Membros do Grupo
          </button>
        </h2>
        <div id="collapseOneMembers" class="accordion-collapse collapse show" aria-labelledby="headingOne"
             data-bs-parent="#accordionMembers">
          <div class="overflow-auto accordion-body p-1 overflow-auto" style="max-height: 350px">
            <div class="list-group list-group-flush overflow-auto">
              <span class="mx-auto p-2 fw-bold small"
                    *ngIf="group_list.length == 0">Não existem membros neste grupo.</span>
              <button *ngFor="let member of currentGroup?.members!" class="list-group-item list-group-item-action">
                <div class="d-flex justify-content-between align-items-center">
                  <div class="fw-bold">{{ member.name }}</div>
                  <!--                  <i-->
                  <!--                    class="ms-1 bi {{ member?.id === currentGroup.groupOwnerId ? 'bi-award-fill' : 'bi-person-fill' }}"></i>-->
                </div>
                <!--<span class="text-muted small text-truncate">{{group.lastMessage.member}}: {{group.lastMessage.message}}</span>-->
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Coluna direita que contém informação consoante a "Group Action" -->
  <div *ngIf="!submitting && !ws_loading" class="col-12 col-md-9 d-flex flex-column">
    <div *ngIf="currentGroup" class="d-flex flex-row justify-content-between">
      <div class="d-flex flex-row align-items-center">
        <span class="text-center fs-2 me-2"> {{ currentGroup.name }}</span>
      </div>
      <div class="d-flex flex-row mt-2 mb-2">
        <button class="btn btn-sm btn-success me-2"
                *ngIf="isActionNone && currentGroup.properties.length < 6"
                (click)="showAddPropertyModal()"
                matTooltip="Adicionar propriedade">
          <i class="bi bi-house-add-fill"></i>
        </button>
        <button class="btn btn-sm btn-info me-2"
                *ngIf="isOwner && currentGroup.groupAction === 'None' && currentGroup.properties.length > 0"
                (click)="startVoting()"
                matTooltip="Iniciar votação">
          <i class="bi bi-chat-square-heart-fill"></i>
        </button>
        <button class="btn btn-sm btn-success me-2"
                *ngIf="isOwner && isActionVoting && !hasChosenProperty"
                (click)="concludeVoting()"
                matTooltip="Concluir votação">
          <i class="bi bi-chat-square-heart-fill"></i>
        </button>
        <button class="btn btn-sm btn-success me-2" *ngIf="isOwner && isActionVoting && hasChosenProperty"
                (click)="startBooking()"
                matTooltip="Efetuar reserva">
          <i class="bi bi-credit-card-fill"></i>
        </button>
        <button class="btn btn-sm btn-secondary me-2"
                (click)="copyGroupLink()"
                matTooltip="Copiar link de convite">
          <i class="bi bi-link"></i>
        </button>
        <button class="btn btn-sm btn-danger"
                *ngIf="isOwner" matTooltip="Apagar grupo"
                (click)="showDeleteGroupModal()">
          <i class="bi bi-trash"></i>
        </button>
      </div>
    </div>

    <div *ngIf="!currentGroup" class="text-center m-auto">
      <h5>Selecione um grupo na barra lateral ou crie um novo grupo de reserva!</h5>
    </div>

    <!--  Lista de propriedades  -->
    <div *ngIf="currentGroup && (isActionNone || isActionVoting)"
         class="d-flex flex-column justify-content-center align-items-center mt-2 property-list">
      <div *ngIf="currentGroup?.properties?.length == 0" class="mx-auto p-2">
        <span class="text-muted small">Não existem propriedades para este grupo.</span>
      </div>
      <div class="w-100 h-100"
           *ngIf="currentGroup && currentGroup.properties?.length !== 0 && (isActionNone || isActionVoting)">
        <div
          class="row row-cols-xl-4 row-cols-lg-3 row-cols-md-2 row-cols-1 g-2 flex-nowrap pb-1 overflow-x-auto custom-scroll h-100">
          <div class="col" *ngFor="let property of currentGroup?.properties">
            <div class="card h-100 w-100"
                 [ngClass]="{
                 'border-success': isPropertyChosen(property.propertyId),
                 'border-info': isPropertyVotedByUser(property.propertyId) && !currentGroup.chosenProperty,
                 'border-5 rounded': isPropertyVotedByUser(property.propertyId) || isPropertyChosen(property.propertyId)}">
              <img class="card-img object-fit-cover opacity-50 h-100 w-100"
                   [ngSrc]="property.imagesUrl[0]" fill priority
                   [ngClass]="{'rounded-0': isPropertyChosen(property.propertyId) || isPropertyVotedByUser(property.propertyId)}"
                   alt="Imagem da Propriedade">
              <div class="card-img-overlay d-flex flex-column">
                <div class="on-hover-pointer flex-grow-1" [routerLink]="['/property',property.propertyId]">
                  <div class="card-title fw-bolder fs-5 text-truncate">{{ property.name }}</div>
                  <div class="card-text text-truncate fw-bolder">{{ property.pricePerNight }}€ / noite</div>
                </div>
                <div class="d-flex flex-row">
                  <button class="btn btn-sm btn-danger me-2"
                          *ngIf="isActionNone && (property.addedBy.id === user?.userId || isOwner) && !hasChosenProperty"
                          matTooltip="Remover propriedade"
                          (click)="removeProperty(property.propertyId)">
                    <i class="bi bi-x-square"></i>
                  </button>
                  <button class="btn btn-sm btn-info"
                          *ngIf="isActionVoting && !hasVotedInProperty(property) && !hasChosenProperty"
                          matTooltip="Votar na propriedade"
                          (click)="voteForProperty(property.propertyId)">
                    <i class="bi bi-check2-circle"></i>
                  </button>
                  <button class="btn btn-sm btn-danger"
                          *ngIf="isActionVoting && hasVotedInProperty(property) && !hasChosenProperty"
                          matTooltip="Remover voto na propriedade"
                          (click)="removeVote(property.propertyId)">
                    <i class="bi bi-check2-circle"></i>
                  </button>
                  <div class="flex-fill on-hover-pointer" [routerLink]="['/property',property.propertyId]"></div>
                  <span class="badge text-bg-info rounded p-2"
                        *ngIf="isActionVoting && !hasChosenProperty">
                    {{ numberOfPropertyVotes(property.propertyId) }}<i class="bi bi-person ms-1"></i>
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!--  Mensagem de espera pela reserva  -->
    <div *ngIf="!isOwner && isActionBooking"
         class="d-flex flex-column justify-content-center w-100 text-center bg-dark-subtle border border-3 rounded-3 border-dark booking-info">
      <p class="fs-5 fw-bolder">Por favor, aguarde enquanto o líder do grupo determina a data para efetuar a
        reserva.</p>
      <span class="fs-6 text-muted fw-bolder">Uma vez concluída esta etapa, serão fornecidos os detalhes de pagamento pertinentes à sua parcela como membro.</span>
    </div>
    <!--  Informação da reserva  -->
    <div *ngIf="isOwner && isActionBooking && chosenProperty"
         class="row mt-2 w-100 booking-info-owner">
      <div *ngIf="currentWidth >= 1500" class="col-3">
        <div class="card h-100 w-100">
          <img class="card-img object-fit-cover opacity-50 h-100 w-100"
               [ngSrc]="chosenProperty!.imagesUrl[0]" fill priority
               [ngClass]="{'rounded-0': isPropertyChosen(chosenProperty!.propertyId) || isPropertyVotedByUser(chosenProperty!.propertyId)}"
               alt="Imagem da Propriedade">
          <div class="card-img-overlay d-flex flex-column">
            <div class="on-hover-pointer flex-grow-1" [routerLink]="['/property',chosenProperty.propertyId]">
              <div class="card-title fw-bolder fs-5 text-truncate">{{ chosenProperty.name }}</div>
              <div class="card-text text-truncate fw-bolder">{{ chosenProperty.pricePerNight }}€ / noite</div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-xxl-5 col-7">
        <div class="d-flex flex-row h-100">
          <div *ngIf="currentWidth >= 1500" class="vr vertical-rule align-self-center"></div>
          <div class="h-100 w-100 d-flex flex-column">
            <span class="text-center fs-4 fw-bolder">Selecionar Datas da reserva</span>
            <form class="px-3 mt-4 flex-grow-1"
                  [formGroup]="bookPropertyForm" (submit)="showAddPropertyModal()">
              <mat-form-field class="w-100 flex-grow-1" (click)="picker.open()">
                <mat-label>Selecione as datas</mat-label>
                <mat-date-range-input [rangePicker]="picker" [dateFilter]="filterDates" [max]="maxDate">
                  <input matStartDate placeholder="Check-In" formControlName="checkIn"
                         (dateChange)="onDateChange($event,'checkIn')">
                  <input matEndDate placeholder="Check-Out" formControlName="checkOut"
                         (dateChange)="onDateChange($event,'checkOut')">
                </mat-date-range-input>
                <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
                <mat-datepicker-toggle matSuffix (click)="clearDates()">
                  <mat-icon matDatepickerToggleIcon>clear</mat-icon>
                </mat-datepicker-toggle>
                <mat-date-range-picker [dateClass]="discountClass" #picker></mat-date-range-picker>
              </mat-form-field>
              <h6 class="text-muted text-center w-100 mb-3">Ainda não vai ser cobrado</h6>
              <div class="mx-auto w-50 mt-2">
                <button class="btn btn-success w-100 mx-auto">Reservar</button>
              </div>
            </form>
          </div>
          <div class="vr vertical-rule align-self-center"></div>
        </div>
      </div>
      <div class="col-xxl-4 col-5">
        <div *ngIf="checkIn && checkOut" class="d-flex flex-column align-content-center h-100 w-100">
          <div class="text-center mb-3">
            <span class="fs-4 fw-bolder ">Total da reserva</span>
          </div>
          <div>
            <div *ngFor="let entry of pricesMap | keyvalue">
              <h6 class="text-secondary mt-2"><u>{{ formatPrice(entry) }}</u></h6>
            </div>
          </div>
          <hr *ngIf="pricesMap.size > 0">
          <div class="mb-3 d-flex flex-row justify-content-between">
            <span>Total </span>
            <span>{{ totalDiscount() }}€</span>
          </div>
        </div>
        <div class="d-flex h-100">
          <span *ngIf="!checkIn || !checkOut" class="m-auto text-center">Selecione as datas para efetuar a reserva.</span>
        </div>
      </div>
    </div>
    <!--  Chat chat -->
    <div class="d-flex flex-column flex-grow-1" *ngIf="currentGroup">
      <app-chat-new class="chat h-50"></app-chat-new>
    </div>
    <div *ngIf="submitting || ws_loading" class="col-12 col-md-9 d-flex flex-column h-100">
      <app-loader class="w-100"></app-loader>
    </div>
  </div>

  <div *ngIf="global_loading" class="m-auto">
    <app-loader></app-loader>
  </div>
</div>
