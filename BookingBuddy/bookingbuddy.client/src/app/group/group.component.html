<div *ngIf="!global_loading" class="row justify-content-center mt-4 w-100">
  <div class="col-md-3 mb-5">
    <div class="accordion mb-3" id="accordionGroups">
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingOne">
          <button class="accordion-button collapsed shadow-sm" type="button" data-bs-toggle="collapse"
                  data-bs-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
            Lista de Grupos
          </button>
        </h2>
        <div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne"
             data-bs-parent="#accordionGroups">
          <div class="overflow-auto accordion-body p-1 overflow-auto" style="max-height: 350px">
            <div class="list-group list-group-flush overflow-auto">
              <div class="mx-auto p-2">
                <span class="text-muted small">Criar um grupo de reserva<button type="button"
                                                                                class="btn btn-outline-success btn-sm rounded-pill ms-2"
                                                                                routerLink="/group-booking"><i
                  class="bi bi-person-fill-add"></i></button></span>
              </div>
              <hr class="m-0"/>
              <span class="mx-auto p-2 fw-bold small"
                    *ngIf="group_list.length == 0">Não existem grupos de reserva</span>
              <button *ngFor="let group of group_list" class="list-group-item list-group-item-action"
                      (click)="chooseGroup(group)" [ngClass]="{'bg-success text-white': group === currentGroup}">
                <div class="d-flex justify-content-between align-items-center">
                  <div class="fw-bold">{{ group.name }}</div>
                  <!--                  <span class="badge bg-success-medium rounded">{{ group.membersId.length }}<i-->
                  <!--                    class="bi bi-person ms-1"></i></span>-->
                </div>
                <!--<span class="text-muted small text-truncate">{{group.lastMessage.member}}: {{group.lastMessage.message}}</span>-->
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="accordion" id="accordionMembers" *ngIf="currentGroup">
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingOne">
          <button class="accordion-button collapsed shadow-sm" type="button" data-bs-toggle="collapse"
                  data-bs-target="#collapseOneMembers" aria-expanded="false" aria-controls="collapseOneMembers">
            Membros do Grupo
          </button>
        </h2>
        <div id="collapseOneMembers" class="accordion-collapse collapse show" aria-labelledby="headingOne"
             data-bs-parent="#accordionMembers">
          <div class="overflow-auto accordion-body p-1 overflow-auto" style="max-height: 350px">
            <div class="list-group list-group-flush overflow-auto">
              <span class="mx-auto p-2 fw-bold small"
                    *ngIf="group_list.length == 0">Não existem membros neste grupo.</span>
              <button *ngFor="let member of currentGroup?.members!" class="list-group-item list-group-item-action">
                <div class="d-flex justify-content-between align-items-center">
                  <div class="fw-bold">{{ member.name }}</div>
                  <!--                  <i-->
                  <!--                    class="ms-1 bi {{ member?.id === currentGroup.groupOwnerId ? 'bi-award-fill' : 'bi-person-fill' }}"></i>-->
                </div>
                <!--<span class="text-muted small text-truncate">{{group.lastMessage.member}}: {{group.lastMessage.message}}</span>-->
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-12 col-md-9 d-flex flex-column">
    <div #successAlerts class="alert alert-success alert-dismissible fade show" role="alert"
         *ngFor="let success_message of success_alerts">
      <span>{{ success_message }}</span>
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    <div #errorAlerts class="alert alert-danger alert-dismissible fade show" role="alert"
         *ngFor="let error_message of errors">
      <span>{{ error_message }}</span>
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    <div *ngIf="currentGroup" class="d-flex flex-row justify-content-between">
      <span class="text-center fs-2">{{ currentGroup.name }}</span>
      <div class="d-flex flex-row mt-2 mb-2">
        <button class="btn btn-sm btn-secondary me-2" (click)="copyGroupLink()" matTooltip="Copiar link de convite"><i
          class="bi bi-link"></i></button>
        <button class="btn btn-sm btn-warning me-2" *ngIf="isGroupOwner" (click)="setGroupAction('voting')"
                matTooltip="Iniciar Votação"><i class="bi bi-chat-square-heart-fill"></i></button>
        <button class="btn btn-sm btn-success me-2" *ngIf="isGroupOwner" (click)="setGroupAction('booking')"
                matTooltip="Efetuar Reserva"><i class="bi bi-credit-card-fill"></i></button>
        <button class="btn btn-sm btn-danger" *ngIf="isGroupOwner" data-bs-toggle="modal"
                data-bs-target="#deleteGroupModal" matTooltip="Apagar Grupo"><i class="bi bi-trash"></i></button>
      </div>
    </div>

    <div class="d-flex flex-column justify-content-center align-items-center mt-2 property-list">
      <div *ngIf="!currentGroup" class="text-center">
        <h5>Selecione um grupo na barra lateral ou crie um novo grupo de reserva!</h5>
      </div>
      <div *ngIf="currentGroup?.properties?.length == 0" class="mx-auto p-2">
        <span class="text-muted small">Não existem propriedades para este grupo.</span>
      </div>
      <div class="w-100 h-100"
           *ngIf="currentGroup && currentGroup.properties?.length !== 0 && currentGroup.groupAction === 'None' || currentGroup?.groupAction === 'Voting'">
        <div class="row row-cols-1 row-cols-md-4 g-2 flex-nowrap pb-1 overflow-x-auto custom-scroll h-100">
          <div class="col property" *ngFor="let property of currentGroup?.properties">
            <div class="card h-100 w-100">
              <img class="card-img object-fit-cover opacity-50 h-100 w-100" [src]="property.imagesUrl[0]"
                   alt="Imagem da Propriedade">
              <div class="card-img-overlay d-flex flex-column">
                <div class="on-hover-pointer flex-grow-1" [routerLink]="['/property',property.propertyId]">
                  <div class="card-title fw-bolder fs-5 text-truncate">{{ property.name }}</div>
                  <div class="card-text text-truncate fw-bolder">{{ property.pricePerNight }}€ / noite</div>
                </div>
                <div class="d-flex flex-row">
                  <button class="btn btn-sm btn-danger me-2"
                          *ngIf="currentGroup?.groupAction !== 'Voting' && property.addedBy.id===user?.userId"
                          matTooltip="Remover Propriedade"
                          (click)="removeProperty(property.propertyId)">
                    <i class="bi bi-x-square"></i>
                  </button>
                  <button class="btn btn-sm btn-info" *ngIf="currentGroup?.groupAction === 'Voting'"
                          matTooltip="Selecionar Propriedade"><i
                    class="bi bi-check2-circle"></i></button>
                  <button class="btn btn-sm btn-success ms-2"
                          *ngIf="currentGroup?.groupAction === 'Voting' && isGroupOwner"
                          matTooltip="Selecionar Propriedade DEV"><i
                    class="bi bi-check2-circle"></i>
                  </button>
                  <div class="flex-fill on-hover-pointer" [routerLink]="['/property',property.propertyId]"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- TODO: Criar componente para o passo seguinte -->
      <!--      <div *ngIf="currentGroup && currentGroup?.chosenProperty && currentGroup.groupAction === 'Booking'" class="w-100">-->
      <!--        &lt;!&ndash;<h3>Property Escolhida: {{ currentGroup?.choosenProperty }}</h3>&ndash;&gt;-->
      <!--        &lt;!&ndash;<app-payment [data]="bookingData"></app-payment>&ndash;&gt;-->
      <!--        <div class="text-center text-wrap text-muted mt-2 mb-4" *ngIf="!isGroupOwner">-->
      <!--          <h5>Por favor, aguarde enquanto o líder do grupo determina a data para efetuar a reserva.</h5>-->
      <!--          <h5>Uma vez concluída esta etapa, serão fornecidos os detalhes de pagamento pertinentes à sua parcela como-->
      <!--            membro.</h5>-->
      <!--        </div>-->
      <!--        <div class="w-75 text-center mx-auto mb-4" *ngIf="isGroupOwner">-->
      <!--          <form [formGroup]="reservarPropriedadeForm" (submit)="reservar($event)">-->
      <!--            <mat-form-field (click)="picker.open()">-->
      <!--              <mat-label>Selecione as datas</mat-label>-->
      <!--              <mat-date-range-input [rangePicker]="picker" [dateFilter]="dateFilter" [max]="maxDate">-->
      <!--                <input matStartDate placeholder="Check-In" formControlName="checkIn"-->
      <!--                       (dateChange)="onDateChange($event, 'start')">-->
      <!--                <input matEndDate placeholder="Check-Out" formControlName="checkOut"-->
      <!--                       (dateChange)="onDateChange($event, 'end')">-->
      <!--              </mat-date-range-input>-->
      <!--              <mat-datepicker-toggle *ngIf="!checkInDate" matIconSuffix [for]="picker"></mat-datepicker-toggle>-->
      <!--              <mat-datepicker-toggle *ngIf="checkInDate" matSuffix (click)="clearDates()">-->
      <!--                <mat-icon matDatepickerToggleIcon>clear</mat-icon>-->
      <!--              </mat-datepicker-toggle>-->
      <!--              <mat-date-range-picker [dateClass]="discountClass" #picker></mat-date-range-picker>-->
      <!--            </mat-form-field>-->

      <!--            <div class="mb-1">-->
      <!--              <label for="hospedes">Hóspedes: {{ getGroupMembers() }}</label>-->
      <!--            </div>-->
      <!--            <button class="btn btn-success mt-1 mb-3">Reservar</button>-->
      <!--            <h6 class="text-secondary mb-3">Ainda não vai ser cobrado</h6>-->
      <!--            <div class="precos mb-2">-->
      <!--              <div *ngFor="let formattedString of formatPricesMap()">-->
      <!--                <h6 class="text-secondary mb-2"><u>{{ formattedString }}</u></h6>-->
      <!--              </div>-->
      <!--            </div>-->
      <!--            <hr class="mt-4 mb-2">-->
      <!--            <div class="mb-4">-->
      <!--              <span>Total: </span>-->
      <!--              <span>{{ calcularTotalDesconto() }}€</span>-->
      <!--            </div>-->
      <!--          </form>-->
      <!--        </div>-->
      <!--      </div>-->

      <div *ngIf="currentGroup && currentGroup.groupAction === 'Paying'">
        <app-payment [data]="setBookingData()"></app-payment>
      </div>
    </div>

    <div class="d-flex flex-column flex-grow-1" *ngIf="currentGroup">
      <div class="d-flex flex-row justify-content-around align-items-center">
        <button type="button" class="btn btn-md btn-success me-2" data-bs-toggle="modal"
                data-bs-target="#addPropertyModal ">Adicionar Propriedade<i class="bi bi-house-add-fill ms-2"></i>
        </button>
        <div class="flex-fill"></div>
        <button class="btn btn-md btn-dark" *ngIf="currentGroup && currentGroup.chosenProperty">
          Reservar Selecionada<i class="bi bi-arrow-right ms-2 "></i>
        </button>
      </div>
      <app-chat-new class="chat"></app-chat-new>
    </div>
    <div *ngIf="submitting " class="h-100">
      <app-loader></app-loader>
    </div>
  </div>
</div>

<div class="modal fade align-self-center" id="deleteGroupModal" tabindex="-1" aria-labelledby="deleteGroupModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteGroupModalLabel">Apagar Grupo</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Tem certeza de que deseja apagar este grupo?</p>
        <p>Esta ação é <strong>irreversível</strong> e resultará na exclusão do grupo para todos os membros. Todos os
          dados associados serão perdidos.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-danger" data-bs-dismiss="modal" (click)="deleteGroup()">Apagar</button>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="addPropertyModal" tabindex="-1" aria-labelledby="addPropertyModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addPropertyModalLabel">Adicionar Propriedade</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="text-muted">Leia cuidadosamente os seguintes procedimentos.</p>
        <p>Para adicionar uma propriedade ao seu grupo de reserva deve:</p>
        <ol class="list-group list-group-numbered list-group-flush mb-2">
          <li class="list-group-item"><strong>Ir para a Página Inicial:</strong> Clique em "Aceitar" para começar a
            explorar.
          </li>
          <li class="list-group-item"><strong>(Opcional) Pesquisar e Filtrar:</strong> Encontre uma propriedade que se
            adeque às suas necessidades.
          </li>
          <li class="list-group-item"><strong>Adicionar ao Grupo:</strong> Selecione uma propriedade e clique em
            "Adicionar ao Grupo de Reserva".
          </li>
          <li class="list-group-item"><strong>Selecionar Grupo:</strong> Escolha o grupo de reserva onde deseja
            incluir a propriedade.
          </li>
          <li class="list-group-item"><strong>Concluir:</strong> A propriedade será automaticamente adicionada ao
            grupo selecionado.
          </li>
        </ol>
        <p class="mt-2"><strong>NOTA:</strong> Para cada grupo de reserva existe um máximo de 6 propriedades a
          escolher.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-success" data-bs-dismiss="modal" routerLink="/">Aceitar</button>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="acceptInvite" tabindex="-1" aria-labelledby="acceptInviteLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="acceptInviteLabel">Convite para grupo de reserva</h5>
        <button *ngIf="failed_invite && !submitting_invite" type="button" class="btn-close" data-bs-dismiss="modal"
                aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <span
          *ngIf="!failed_invite && !submitting_invite">Aceitar o convite para o grupo de reserva <strong>{{ pendingGroup?.name }}</strong>?</span>
        <span *ngIf="failed_invite && !submitting_invite"
              class="text-center">Ocorreu um erro ao aceitar o convite!</span>
        <app-loader class="m-3" *ngIf="submitting_invite"></app-loader>
      </div>
      <div *ngIf="!submitting_invite" class="modal-footer">
        <button *ngIf="!failed_invite" type="button" class="btn btn-danger" data-bs-dismiss="modal"
                [routerLink]="['/groups']">
          Rejeitar
        </button>
        <button *ngIf="!failed_invite" type="button" class="btn btn-success" (click)="acceptInvite()">
          Aceitar
        </button>
        <button *ngIf="failed_invite" type="button" class="btn btn-danger" data-bs-dismiss="modal"
                [routerLink]="['/groups']">
          Fechar
        </button>
      </div>
    </div>
  </div>
</div>

<div *ngIf="global_loading" class="m-auto">
  <app-loader></app-loader>
</div>
